<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Notion Address Autocomplete</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<style>
		.container {
			max-width: 800px;
			margin-top: 2rem;
		}

		#map {
			height: 300px;
			margin-top: 1rem;
			display: none;
		}

		.pac-container {
			z-index: 1051 !important;
		}
	</style>
</head>

<body>
	<div class="container">
		<h1>Notion Address Autocomplete</h1>
		<p class="lead">Select a page and property to add a location with autocomplete.</p>

		<div class="card mb-4">
			<div class="card-body">
				<h5 class="card-title">Select Page and Property</h5>
				<div class="mb-3">
					<label for="pageSelect" class="form-label">Notion Page</label>
					<select id="pageSelect" class="form-select"></select>
				</div>
				<div class="mb-3">
					<label for="propertySelect" class="form-label">Property for Address</label>
					<select id="propertySelect" class="form-select"></select>
				</div>
			</div>
		</div>

		<div class="card">
			<div class="card-body">
				<h5 class="card-title">Address Lookup</h5>
				<div class="mb-3">
					<label for="addressInput" class="form-label">Search for address</label>
					<input id="addressInput" class="form-control" type="text" placeholder="Start typing an address...">
				</div>
				<div id="map"></div>
				<div class="mt-3" id="addressDetails">
					<p><strong>Selected Address:</strong> <span id="selectedAddress">None</span></p>
				</div>
				<button id="saveButton" class="btn btn-primary mt-3" disabled>Save to Notion</button>
			</div>
		</div>

		<div class="alert alert-success mt-3" id="successAlert" style="display: none;">
			Address successfully saved to Notion!
		</div>
	</div>

	<script>
		let map;
		let autocomplete;
		let placeData = null;
		let pages = [];
		let databaseProperties = {};

		// Initialize when page loads
		document.addEventListener('DOMContentLoaded', initialize);

		function initialize() {
			loadPages();

			// Set up event listeners
			document.getElementById('pageSelect').addEventListener('change', handlePageSelect);
			document.getElementById('saveButton').addEventListener('click', saveAddressToNotion);
		}

		function loadPages() {
			fetch('/api/pages')
				.then(response => response.json())
				.then(data => {
					pages = data.results;
					const pageSelect = document.getElementById('pageSelect');
					pageSelect.innerHTML = '<option value="">Select a page...</option>';

					pages.forEach(page => {
						const option = document.createElement('option');
						option.value = page.id;

						// Try to get page title from various possible properties
						let title = "Untitled";
						if (page.properties.Name && page.properties.Name.title && page.properties.Name.title.length > 0) {
							title = page.properties.Name.title[0].plain_text;
						} else if (page.properties.Title && page.properties.Title.title && page.properties.Title.title.length > 0) {
							title = page.properties.Title.title[0].plain_text;
						}

						option.textContent = title;
						pageSelect.appendChild(option);
					});
				})
				.catch(error => {
					console.error('Error loading pages:', error);
					alert('Failed to load pages from Notion');
				});
		}

		function loadDatabaseProperties() {
			fetch('/api/database')
				.then(response => response.json())
				.then(data => {
					databaseProperties = data.properties;
					const propertySelect = document.getElementById('propertySelect');
					propertySelect.innerHTML = '<option value="">Select a property...</option>';

					// Only show text-based properties
					Object.entries(databaseProperties).forEach(([key, property]) => {
						if (property.type === 'rich_text' || property.type === 'title' || property.type === 'url') {
							const option = document.createElement('option');
							option.value = key;
							option.textContent = key;
							propertySelect.appendChild(option);
						}
					});
				})
				.catch(error => {
					console.error('Error loading database properties:', error);
					alert('Failed to load database properties from Notion');
				});
		}

		function handlePageSelect() {
			loadDatabaseProperties();
		}

		function initializeMap() {
			 // Fetch the Google API key from the server
			fetch('/api/google-api-key')
				.then(response => response.json())
				.then(data => {
					const script = document.createElement('script');
					script.src = `https://maps.googleapis.com/maps/api/js?key=${data.apiKey}&libraries=places&callback=initAutocomplete`;
					script.async = true;
					script.defer = true;
					document.head.appendChild(script);
				})
				.catch(error => {
					console.error('Error loading Google API key:', error);
					alert('Failed to load Google API key');
				});
		}

		function initAutocomplete() {
			const mapElement = document.getElementById('map');
			mapElement.style.display = 'block';

			map = new google.maps.Map(mapElement, {
				center: { lat: 37.7749, lng: -122.4194 },
				zoom: 13
			});

			autocomplete = new google.maps.places.Autocomplete(
				document.getElementById('addressInput'),
				{ types: ['address'] }
			);

			autocomplete.addListener('place_changed', fillInAddress);
		}

		function fillInAddress() {
			const place = autocomplete.getPlace();
			placeData = place;

			document.getElementById('selectedAddress').textContent = place.formatted_address;
			document.getElementById('saveButton').disabled = false;

			// Center map on selected location
			if (place.geometry && place.geometry.location) {
				map.setCenter(place.geometry.location);
				new google.maps.Marker({
					map: map,
					position: place.geometry.location
				});
			}
		}

		function saveAddressToNotion() {
			const pageId = document.getElementById('pageSelect').value;
			const propertyName = document.getElementById('propertySelect').value;

			if (!pageId || !propertyName || !placeData) {
				alert('Please select a page, property, and address');
				return;
			}

			const addressData = {
				pageId: pageId,
				propertyName: propertyName,
				address: placeData.formatted_address,
				placeId: placeData.place_id,
				lat: placeData.geometry.location.lat(),
				lng: placeData.geometry.location.lng()
			};

			fetch('/api/update-address', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify(addressData)
			})
				.then(response => response.json())
				.then(data => {
					if (data.success) {
						const successAlert = document.getElementById('successAlert');
						successAlert.style.display = 'block';
						setTimeout(() => {
							successAlert.style.display = 'none';
						}, 3000);
					} else {
						throw new Error('Failed to update Notion');
					}
				})
				.catch(error => {
					console.error('Error saving address:', error);
					alert('Failed to save address to Notion');
				});
		}

		// Call this after page loads to start the Google Maps integration
		setTimeout(initializeMap, 1000);
	</script>
</body>

</html>